<?php

include('config.php');
include('./Gate/chk.php');
session_start();
if (!isset($_SESSION['user_id'])) {
    header("Location: login.php");
    exit();
}

$user_id = $_SESSION['user_id'];

$sql = "SELECT username, credit, total_cc, usertype FROM users WHERE id = '$user_id' LIMIT 1";
$result = mysqli_query($conn, $sql);

if (mysqli_num_rows($result) > 0) {
    $user = mysqli_fetch_assoc($result);
    $username = $user['username'];
    $credits = $user['credit'];
    $total_cc = $user['total_cc'];
    $usertype = $user['usertype'];
} else {
    session_destroy();
    header("Location: login.php");
    exit();
}

$response = "";


if ($_SERVER["REQUEST_METHOD"] == "POST") {
    $cc = $_POST['cardNumber'];
    $mes = $_POST['expMonth'];
    $ano = $_POST['expYear'];
    $cvv = $_POST['cvv'];
    
if ($credits > 0) {
    $response = checkcharge($cc, $mes, $ano, $cvv);
    decreaseCredit($user_id);
} else {
    $response = "Insufficient funds, please upgrade to use gate Dead ";
}
    
    $alertClass = (strpos($response, 'Dead') !== false) ? 'alert-danger' : 'alert-info';
}
?>



<!DOCTYPE html>


<html lang="en" class="dark-style layout-navbar-fixed layout-menu-fixed layout-compact layout-menu-collapsed " dir="ltr" data-theme="theme-default" data-assets-path="./assets/" data-template="vertical-menu-template-dark">

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0" />

    <title>Collapsed menu - Layouts | Vuexy - Bootstrap Admin Template</title>

    
    <meta name="description" content="Start your development with a Dashboard for Bootstrap 5" />
    <meta name="keywords" content="dashboard, bootstrap 5 dashboard, bootstrap 5 design, bootstrap 5">
    <!-- Canonical SEO -->
    <link rel="canonical" href="https://1.envato.market/vuexy_admin">
    
    
    <!-- ? PROD Only: Google Tag Manager (Default ThemeSelection: GTM-5DDHKGP, PixInvent: GTM-5J3LMKC) -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
      new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
      j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
      'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
      })(window,document,'script','dataLayer','GTM-5J3LMKC');</script>
    <!-- End Google Tag Manager -->
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="./assets/img/favicon/favicon.ico" />

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Public+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;1,300;1,400;1,500;1,600;1,700&ampdisplay=swap" rel="stylesheet">

    <!-- Icons -->
    <link rel="stylesheet" href="./assets/vendor/fonts/fontawesome.css" />
    <link rel="stylesheet" href="./assets/vendor/fonts/tabler-icons.css"/>
    <link rel="stylesheet" href="./assets/vendor/fonts/flag-icons.css" />

    <!-- Core CSS -->
    <link rel="stylesheet" href="./assets/vendor/css/rtl/core-dark.css" class="template-customizer-core-css" />
    <link rel="stylesheet" href="./assets/vendor/css/rtl/theme-default-dark.css" class="template-customizer-theme-css" />
    <link rel="stylesheet" href="./assets/css/demo.css" />
    
    <!-- Vendors CSS -->
    <link rel="stylesheet" href="./assets/vendor/libs/node-waves/node-waves.css" />
    <link rel="stylesheet" href="./assets/vendor/libs/perfect-scrollbar/perfect-scrollbar.css" />
    <link rel="stylesheet" href="./assets/vendor/libs/typeahead-js/typeahead.css" /> 
    

    <!-- Page CSS -->
    

    <!-- Helpers -->
    <script src="./assets/vendor/js/helpers.js"></script>
    <!--! Template customizer & Theme config files MUST be included after core stylesheets and helpers.js in the <head> section -->
    <!--? Template customizer: To hide customizer set displayCustomizer value false in config.js.  -->
    <script src="./assets/vendor/js/template-customizer.js"></script>
    <!--? Config:  Mandatory theme config file contain global vars & default theme options, Set your preferred theme option in this file.  -->
    <script src="./assets/js/config.js"></script>
    
</head>

<body>

  
  <!-- ?PROD Only: Google Tag Manager (noscript) (Default ThemeSelection: GTM-5DDHKGP, PixInvent: GTM-5J3LMKC) -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-5DDHKGP" height="0" width="0" style="display: none; visibility: hidden"></iframe></noscript>
  <!-- End Google Tag Manager (noscript) -->
  
  <!-- Layout wrapper -->
<div class="layout-wrapper layout-content-navbar  ">
  <div class="layout-container">

    
    




<!-- Menu -->

<?php include './headers/sidebar.php'; ?>
<!-- / Menu -->

    

    <!-- Layout container -->
    <div class="layout-page">
      
      
<?php include './headers/nav.php'; ?>



<!-- / Navbar -->

      <div id="customToast" class="bs-toast toast align-items-center" role="alert" aria-live="assertive" aria-atomic="true" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1055; display: none;">
    <div class="toast-header">
        <i class="ti ti-bell ti-xs me-2 text-danger"></i>
        <div class="me-auto fw-medium" id="toastTitle">Notification</div>
        <small class="text-muted">Just now</small>
        <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close" onclick="hideToast()"></button>
    </div>
    <div class="toast-body" id="toastBody">
        Hello, world! This is a toast message.
    </div>
</div>

      <!-- Content wrapper -->
      <div class="content-wrapper">

        <!-- Content -->
        
          <div class="container-xxl flex-grow-1 container-p-y">
            
            



<div class="layout-demo-info">
  <div class="alert alert-primary mt-4" role="alert">
    <span class="fw-medium">Important:</span> Evry check you will loss 1 credit 
  </div>
</div>



<div class="col-md-6">
  <div class="card mb-4">
    <h5 class="card-header">Braintree Auth</h5>
    <div class="card-body">
      <form method="post">
        <div class="mb-3">
          <label for="cardNumber" class="form-label">Card Number</label>
          <input type="text" class="form-control" id="cardNumber" name="cardNumber" placeholder="Enter card number" required />
        </div>
        
        <div class="mb-3">
          <label for="expMonth" class="form-label">Expiration Month</label>
          <input type="text" class="form-control" id="expMonth" name="expMonth" placeholder="MM" required />
        </div>
        
        <div class="mb-3">
          <label for="expYear" class="form-label">Expiration Year</label>
          <input type="text" class="form-control" id="expYear" name="expYear" placeholder="YYYY" required />
        </div>
        
        <div class="mb-3">
          <label for="cvv" class="form-label">CVV</label>
          <input type="text" class="form-control" id="cvv" name="cvv" placeholder="CVV" required />
        </div>
        
        <button type="submit" class="btn btn-primary">Submit</button>
      </form>
      
      <?php if ($response): ?>
        <div id="response" class="mt-3 alert <?php echo $alertClass; ?>"><?php echo $response; 
?></div>
      <?php endif; ?>
    </div>
  </div>
</div>


<script>
    var userCredits = <?php echo $credits; ?>;  // Pass the credits from PHP to JavaScript
</script>
<!--/ Layout Demo -->


          </div>
          <!-- / Content -->

          
          

<!-- Footer -->
<?php include './headers/footer.php'; ?>
<!-- / Footer -->

          
          <div class="content-backdrop fade"></div>
        </div>
        <!-- Content wrapper -->
      </div>
      <!-- / Layout page -->
    </div>

    
    

  <!-- Core JS -->
  <!-- build:js assets/vendor/js/core.js -->
  
  <script src="./assets/vendor/libs/jquery/jquery.js"></script>
  <script src="./assets/vendor/libs/popper/popper.js"></script>
  <script src="./assets/vendor/js/bootstrap.js"></script>
  <script src="./assets/vendor/libs/node-waves/node-waves.js"></script>
  <script src="./assets/vendor/libs/perfect-scrollbar/perfect-scrollbar.js"></script>
  <script src="./assets/vendor/libs/hammer/hammer.js"></script>
  <script src="./assets/vendor/libs/i18n/i18n.js"></script>
  <script src="./assets/vendor/libs/typeahead-js/typeahead.js"></script>
   <script src="./assets/vendor/js/menu.js"></script>
  
  <!-- endbuild -->

  <!-- Vendors JS -->
  
  

  <!-- Main JS -->
  <script src="./assets/js/main.js"></script>
   <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.6/dist/sweetalert2.all.min.js"></script>
<script>
$(document).ready(function(){
    const swalWithBootstrapButtons = Swal.mixin({
        customClass: {
            confirmButton: 'btn btn-success',
            cancelButton: 'btn btn-danger'
        },
        buttonsStyling: false
    });

    // Function to display toast with custom message
    function showToast(title, message) {
        $('#toastTitle').text(title);
        $('#toastBody').text(message);
        $('#customToast').fadeIn();
        setTimeout(() => {
            $('#customToast').fadeOut();
        }, 3000); // Toast disappears after 3 seconds
    }

    // Copy Lives
    $('.btn-copy').click(function(){
        showToast('Copied!', 'The list has been copied successfully.');
        var lista_lives = $('#lista_aprovadas').text();  // Get the text from approved lives
        copyToClipboard(lista_lives);  // Use helper function to copy
    });

    // Clear Dead
    $('.btn-trash').click(function(){
        showToast('Cleared!', 'The dead list has been cleared.');
        $('#lista_reprovadas').text('');  // Clear the dead list
    });

    // Process Cards Logic
    $('.btn-play').click(function(){
        var lista = $('.form-checker').val().trim();
        var sec = $("#sec").val();
        var e = document.getElementById("gate");
        var gate = e.options[e.selectedIndex].value;
        var array = lista.split('\n');
        var charge = 0, lives = 0, dies = 0, testadas = 0, txt = '';

        // Ensure user has enough credits
        var totalCards = array.filter(function(value) { return value.trim() !== ""; }).length;

        if (!lista) {
            showToast('No Cards!', 'Please enter cards.');
            return false;
        }

        if (userCredits <= 0) {
            showToast('Insufficient Funds!', 'Your credits are insufficient. Please top up.');
            return false;
        }

        // Ensure user has enough credits for the total number of cards
        if (totalCards > userCredits) {
            showToast('Not Enough Credits!', 'You need more credits to check all cards.');
            return false;
        }

        showToast('Checking!', 'Processing started.');

        var line = array.filter(function(value){
            if (value.trim() !== "") {
                txt += value.trim() + '\n';
                return value.trim();
            }
        });

        var total = line.length;
        $('.carregadas').text(total);
        $('.btn-play').attr('disabled', true);
        $('.btn-stop').attr('disabled', false);

        line.forEach(function(data){
            var callBack = $.ajax({
                url: gate + '?lista=' + data + '&sec=' + sec,
                success: function(retorno){
                    if (retorno.indexOf("AUTH") >= 0) {
                        $('#lista_charge').append(retorno);
                        removelinha();
                        charge++;
                    } else if (retorno.indexOf("Live") >= 0) {
                        $('#lista_aprovadas').append(retorno);
                        removelinha();
                        lives++;
                    } else {
                        $('#lista_reprovadas').append(retorno);
                        removelinha();
                        dies++;
                    }

                    testadas = charge + lives + dies;
                    $('.charge').text(charge);
                    $('.aprovadas').text(lives);
                    $('.reprovadas').text(dies);
                    $('.testadas').text(testadas);

                    // Deduct credits as cards are processed
                    userCredits -= 1; // Deduct 1 credit per card processed
                    $('#credits').text(userCredits); // Update the credits UI

                    if (testadas == total) {
                        showToast('Finished!', 'Processing has finished.');
                        $('.btn-play').attr('disabled', false);
                        $('.btn-stop').attr('disabled', true);
                    }
                }
            });

            // Stop button logic to abort the AJAX request
            $('.btn-stop').click(function(){
                showToast('Paused!', 'Processing has been paused.');
                $('.btn-play').attr('disabled', false);
                $('.btn-stop').attr('disabled', true);
                callBack.abort();
                return false;
            });
        });
    });
});

// Helper function to remove the first line (used after processing a card)
function removelinha() {
    var lines = $('.form-checker').val().split('\n');
    lines.splice(0, 1);  // Remove the first line
    $('.form-checker').val(lines.join("\n"));
}

// Helper function to copy text to clipboard
function copyToClipboard(text) {
    var textarea = document.createElement('textarea');
    textarea.value = text;
    document.body.appendChild(textarea);
    textarea.select();
    document.execCommand('copy');
    document.body.removeChild(textarea);
}
</script>
</body>

</html>

<!-- beautify ignore:end -->

